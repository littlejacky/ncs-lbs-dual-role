# üíç Smart Ring - Couple's Connected Hearts

A romantic BLE-enabled smart ring system that allows couples to share heartbeats, send touches, and feel connected across any distance.

## ‚ú® Features

### üíì Heart Rate Sharing
- **Real-time heart synchronization**: Share your heartbeat with your partner instantly
- **Heart rate correlation**: See when your hearts beat in sync
- **Health monitoring**: Track both partners' heart rates with visual alerts for unusual patterns

### ü§ù Touch Interaction
- **Button to LED communication**: Press your ring's button to light up your partner's LED
- **Bidirectional touch**: Both rings can send and receive touch signals
- **Visual feedback**: Confirmation patterns show when touch is sent/received

### üì∂ Distance Monitoring
- **RSSI-based distance estimation**: Automatically detect how close you are to each other
- **Distance categories**: 
  - üíï **Very Close** (Heart touching) - < 0.5m
  - üè† **Close** (Same room) - < 2m  
  - üè¢ **Medium** (Nearby rooms) - < 5m
  - üåÜ **Far** (Different floors) - < 10m
  - üåç **Very Far** (Out of range) - > 10m

### üîÑ Dual Role Support
- Each ring can simultaneously act as both **Central** (scanner/client) and **Peripheral** (advertiser/server)
- Automatic role negotiation and connection management
- Seamless reconnection after disconnections

## üõ†Ô∏è Hardware Requirements

### Supported Platforms
- **Primary**: nRF54L15 (Nordic nRF Connect SDK v3.1.0)
- **Compatible**: nRF52840, nRF52833, nRF5340
- **Framework**: Zephyr RTOS v4.1.99+

### Components
- Nordic nRF development board with BLE 5.0+ support
- User button (for touch interaction)
- LEDs (status indicators and partner notification)
- Heart rate sensor (optional - can simulate data)

### Pin Configuration
```c
#define RUN_STATUS_LED             DK_LED1  // System status
#define CENTRAL_CON_STATUS_LED     DK_LED2  // Central connection
#define PERIPHERAL_CONN_STATUS_LED DK_LED3  // Peripheral connection  
#define USER_LED                   DK_LED4  // Partner interaction

#define USER_BUTTON    DK_BTN1_MSK           // Touch button
```

## üöÄ Quick Start

### 1. Environment Setup
```bash
# Install nRF Connect SDK v3.1.0
# https://docs.nordicsemi.com/bundle/ncs-latest/page/nrf/getting_started.html

# Clone this repository
git clone https://github.com/littlejacky/ncs-lbs-dual-role.git
cd ncs-lbs-dual-role
```

### 2. Configuration
Add to your `prj.conf` for real RSSI monitoring:
```ini
# Enable RSSI monitoring (NCS v3.1.0)
CONFIG_BT_CTLR_CONN_RSSI=y
CONFIG_BT_HCI_VS=y
CONFIG_BT_PATH_LOSS_MONITORING=y
CONFIG_BT_CTLR_TX_PWR_DYNAMIC=y

# Required BLE services
CONFIG_BT_DEVICE_NAME="SmartRing"
CONFIG_BT_DEVICE_APPEARANCE=576
CONFIG_BT_LBS=y
CONFIG_BT_HRS=y

# Enable settings for bonding
CONFIG_SETTINGS=y
CONFIG_BT_SETTINGS=y
```

### 3. Build and Flash
```bash
# Build for nRF54L15
west build -b nrf54l15dk/nrf54l15/cpuapp

# Flash to device
west flash

# View logs
west log
```

### 4. Pairing Process
1. **Flash both devices** with the same firmware
2. **Power on both rings** - they will automatically discover each other
3. **Wait for connection** - Look for "Ring pairing setup complete!" message
4. **Test interaction** - Press button on one ring to light up the other
5. **Monitor status** - Check periodic status reports in console

## üì± Usage Guide

### Basic Operation
1. **Power On**: Ring starts advertising and scanning simultaneously
2. **Auto-Discovery**: Rings find each other using Heart Rate Service UUID
3. **Auto-Pairing**: Automatic Just-Works pairing for seamless connection
4. **Ready to Use**: Press button or monitor heart rate sharing

### LED Status Indicators
| LED | Status | Meaning |
|-----|--------|---------|
| LED1 | Blinking | System running normally |
| LED2 | Solid | Connected as Central (found partner) |
| LED3 | Solid | Connected as Peripheral (partner found you) |
| LED4 | Flash/Solid | Partner interaction (button press) |

### Console Commands
Monitor real-time status via UART console:
```
=== Ring Status ===
Central: Connected, RSSI: -45 dBm, Distance: Close
  HRS Ready: ‚úì, LBS Ready: ‚úì
  Partner HR: 72 bpm
Peripheral: Connected, RSSI: -48 dBm, Distance: Close
Button: Released, LED: OFF
==================
```

## üèóÔ∏è Architecture

### Services Used
- **Heart Rate Service (HRS)**: 
  - Server: Shares your heart rate
  - Client: Receives partner's heart rate
- **LED Button Service (LBS)**:
  - Server: Provides button state, controls LED
  - Client: Reads partner's button, controls partner's LED
- **Battery Service (BAS)**: Battery level monitoring

### Connection Roles
```
Ring A (Central + Peripheral)  ‚Üê‚Üí  Ring B (Central + Peripheral)
     ‚Üì                                      ‚Üì
   Scans for                              Advertises
   Partner Ring                           Availability
     ‚Üì                                      ‚Üì
   Connects &                             Accepts &
   Discovers Services                     Provides Services
```

### Data Flow
1. **Heart Rate**: HRS Client ‚Üê BLE ‚Üí HRS Server
2. **Button Press**: LBS Client ‚Üê BLE ‚Üí LBS Server  
3. **LED Control**: LBS Client ‚Üí BLE ‚Üí LBS Server
4. **Distance**: RSSI monitoring via connection callbacks

## üîß Customization

### Distance Thresholds
Modify RSSI thresholds in `main.c`:
```c
#define RSSI_VERY_CLOSE_THRESHOLD  (-30)  /* < 0.5m */
#define RSSI_CLOSE_THRESHOLD       (-50)  /* < 2m */
#define RSSI_MEDIUM_THRESHOLD      (-70)  /* < 5m */
#define RSSI_FAR_THRESHOLD         (-90)  /* < 10m */
```

### Heart Rate Alerts
Customize heart rate thresholds:
```c
if (meas->hr_value > 100) {
    printk("‚ö† Partner's heart rate is elevated: %d bpm\n", meas->hr_value);
} else if (meas->hr_value < 60) {
    printk("üí§ Partner's heart rate is low: %d bpm\n", meas->hr_value);
}
```

### Update Intervals
```c
#define RSSI_UPDATE_INTERVAL 2000  /* RSSI check every 2 seconds */
#define RUN_LED_BLINK_INTERVAL 1000 /* Status LED blink rate */
```

## üêõ Troubleshooting

### Connection Issues
**Problem**: Rings don't connect automatically
- **Solution**: Ensure both devices are running the same firmware
- Check that HRS service is properly advertised
- Verify scan filters are correctly set

### LED Control Not Working  
**Problem**: Button press doesn't light partner's LED
- **Cause**: LBS service discovery issue
- **Solution**: Check console for "Found LED characteristic handle" message
- Apply the discovery fix if `bt_gatt_dm_attr_next()` returns NULL

### RSSI Shows Simulated Values
**Problem**: Distance monitoring uses simulated data
- **Cause**: Real RSSI monitoring requires specific NCS configuration
- **Solution**: Add RSSI config options to `prj.conf` and implement HCI RSSI reading

### Heart Rate Not Sharing
**Problem**: Partner's heart rate not received
- **Check**: HRS client subscription successful
- **Verify**: Heart rate sensor is providing data
- **Debug**: Monitor HRS notification callbacks

## üìä Performance Notes

### Power Consumption
- **Active Scanning**: ~10-15mA
- **Connected Idle**: ~1-2mA  
- **Heart Rate Monitoring**: ~0.5mA additional
- **LED Notification**: ~5-10mA peak

### Memory Usage
- **RAM**: ~32KB (with connection buffers)
- **Flash**: ~256KB (including BLE stack)
- **Heap**: Minimal (stack-based design)

### Range and Reliability
- **Indoor Range**: ~10-30 meters
- **Outdoor Range**: ~50-100 meters  
- **Reconnection Time**: 1-5 seconds
- **Heart Rate Latency**: <100ms

## ü§ù Contributing

We welcome contributions! Areas for improvement:

### Wanted Features
- [ ] Real RSSI implementation for NCS v3.1.0
- [ ] Power management and battery optimization
- [ ] Mobile app companion
- [ ] Custom vibration patterns
- [ ] Multi-pair support (family rings)
- [ ] Encrypted heart rate data
- [ ] Historical data logging

### Development Guidelines
1. **Code Style**: Follow Zephyr coding standards
2. **Testing**: Test on both nRF52 and nRF54 platforms
3. **Documentation**: Update README for any API changes
4. **Backwards Compatibility**: Support NCS v2.6.0+

## üìÑ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## üôè Acknowledgments

- **Nordic Semiconductor** - nRF Connect SDK and excellent documentation
- **Zephyr Project** - Robust RTOS foundation  
- **Bluetooth SIG** - Standard service specifications
- **Open Source Community** - Inspiration and code examples

## üìû Support

### Getting Help
- **Issues**: [GitHub Issues](https://github.com/littlejacky/ncs-lbs-dual-role/issues)
- **Discussions**: [GitHub Discussions](https://github.com/littlejacky/ncs-lbs-dual-role/discussions)
- **Discord**: [Nordic DevZone Discord](https://discord.gg/nordic)

### Documentation
- [nRF Connect SDK Documentation](https://docs.nordicsemi.com/bundle/ncs-latest/page/nrf/index.html)
- [Zephyr Bluetooth Documentation](https://docs.zephyrproject.org/latest/connectivity/bluetooth/index.html)
- [Nordic DevZone](https://devzone.nordicsemi.com/)

---

## üíñ Made with Love

*This project was created to help couples stay connected across any distance. Whether you're in a long-distance relationship or just want a fun way to share moments throughout the day, these smart rings bring you closer together.*

**Happy coding, and stay connected! üíï**
